<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>V2rayNG_Ghavi - سیستم مدیریت کانفیگ</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
/* استایل‌های اصلی */
@import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap');
:root {
    --bg-color: #010409;
    --card-bg-color: #0d1117;
    --border-color: rgba(255, 255, 255, 0.1);
    --text-color: #e6edf3;
    --text-secondary-color: #7d8590;
    --accent-color: #2f81f7;
    --success-color: #238636;
    --warning-color: #f59e0b;
    --danger-color: #da3633;
    --glow-color: rgba(47, 129, 247, 0.7);
}
* {
    font-family: 'Vazirmatn', sans-serif;
}
body {
    background-color: var(--bg-color);
    color: var(--text-color);
    overflow-x: hidden;
}
.proxy-card {
    transition: all 0.3s ease;
}
.proxy-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}
.status-good { color: #3fb950; }
.status-medium { color: #d29922; }
.status-bad { color: #f85149; }
.loading-spinner {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
/* استایل جدید برای لوگوی خوش آمدگویی */
.welcome-logo {
    width: 120px;
    height: 120px;
    background: linear-gradient(135deg, #2f81f7 0%, #238636 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 30px rgba(47, 129, 247, 0.5);
    border: 3px solid rgba(255,255,255,0.1);
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}
.welcome-logo i {
    font-size: 50px;
    color: white;
}
</style>
</head>
<body>

<!-- مدال خوش آمدگویی بهبود یافته -->
<div id="welcomeModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 transition-opacity duration-300">
  <div class="bg-gray-800 rounded-xl p-8 max-w-md w-full mx-4 border border-gray-700 transform transition-all duration-300 scale-95 opacity-0">
    <div class="flex justify-center mb-6">
      <div class="welcome-logo">
        <i class="fa-solid fa-shield-virus"></i>
      </div>
    </div>
    <h2 class="text-2xl font-bold text-center mb-4">به V2rayNG_Ghavi خوش آمدید</h2>
    <p class="text-gray-400 text-center mb-6">سیستم مدیریت هوشمند کانفیگ‌های V2Ray</p>
    <div class="flex justify-center">
      <button id="closeWelcomeModal" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg transition-all">
        شروع کنید
      </button>
    </div>
  </div>
</div>

<!-- محتوای اصلی -->
<div class="container mx-auto px-4 py-8">
  <header class="text-center mb-12">
    <h1 class="text-4xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-green-400">
      V2rayNG_Ghavi
    </h1>
    <p class="text-xl text-gray-400">مدیریت و تست کانفیگ‌های V2Ray</p>
  </header>

  <div class="flex justify-between mb-6">
    <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg transition-all">
      <i id="refreshIcon" class="fas fa-sync-alt mr-2"></i>
      بروزرسانی
    </button>
    <div class="flex items-center gap-4">
      <div class="text-center">
        <div id="proxyCount" class="text-2xl font-bold">0</div>
        <div class="text-sm text-gray-400">کانفیگ‌ها</div>
      </div>
      <button id="testAllBtn" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg transition-all">
        <i class="fas fa-bolt mr-2"></i>
        تست همه
      </button>
    </div>
  </div>

  <div id="proxyList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
</div>

<script>
// متغیرهای اصلی
let allConfigs = [];
let isLoading = false;
const GIST_URL = "https://gist.githubusercontent.com/Mahyar5803/180f4ad81481ea542c56e29de00898be/raw/8be19fed0de0ba84ec9812e69296dd86a9cf531c/V2ray_Collector";

// نمایش مدال خوش آمدگویی
const welcomeModal = document.getElementById('welcomeModal');
const modalContent = welcomeModal.querySelector('div');
setTimeout(() => {
  modalContent.classList.remove('scale-95', 'opacity-0');
  modalContent.classList.add('scale-100', 'opacity-100');
}, 100);

document.getElementById('closeWelcomeModal').addEventListener('click', () => {
  modalContent.classList.remove('scale-100', 'opacity-100');
  modalContent.classList.add('scale-95', 'opacity-0');
  setTimeout(() => {
    welcomeModal.classList.add('hidden');
  }, 300);
  localStorage.setItem('welcomeShown', 'true');
});

// بارگذاری اولیه
if (!localStorage.getItem('welcomeShown')) {
  welcomeModal.classList.remove('hidden');
} else {
  welcomeModal.classList.add('hidden');
}

// تابع اصلی بارگذاری کانفیگ‌ها
const loadConfigs = async () => {
  if (isLoading) return;
  setLoadingState(true);
  
  try {
    const response = await fetch(`${GIST_URL}?t=${Date.now()}`);
    const rawData = await response.text();
    
    const configs = rawData.split('\n')
      .map(line => line.trim())
      .filter(line => line.length > 10);
    
    // حفظ وضعیت تست‌های قبلی
    allConfigs = configs.map((config, index) => {
      const existing = allConfigs.find(c => c.config === config);
      return existing || {
        id: index + 1,
        config: config,
        ping: null,
        status: 'unknown',
        lastTested: null
      };
    });
    
    updateUI();
    showToast('کانفیگ‌ها با موفقیت بروز شدند', 'success');
  } catch (error) {
    showToast('خطا در دریافت کانفیگ‌ها', 'error');
  } finally {
    setLoadingState(false);
  }
};

// تابع تست پینگ و مرتب‌سازی
const testPing = async (configId) => {
  const config = allConfigs.find(c => c.id === configId);
  if (!config) return;
  
  config.status = 'testing';
  updateUI();
  
  // شبیه‌سازی تست پینگ
  await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 1000));
  
  const ping = Math.floor(Math.random() * 400) + 50;
  config.ping = ping;
  config.lastTested = new Date();
  
  if (ping < 150) config.status = 'good';
  else if (ping < 300) config.status = 'medium';
  else config.status = 'bad';
  
  updateUI();
};

// تست همه کانفیگ‌ها و مرتب‌سازی
const testAllConfigs = async () => {
  if (isLoading) return;
  setLoadingState(true);
  
  for (const config of allConfigs) {
    await testPing(config.id);
  }
  
  // مرتب‌سازی بر اساس پینگ
  allConfigs.sort((a, b) => {
    if (a.ping === null) return 1;
    if (b.ping === null) return -1;
    return a.ping - b.ping;
  });
  
  updateUI();
  setLoadingState(false);
};

// بروزرسانی UI
const updateUI = () => {
  document.getElementById('proxyCount').textContent = allConfigs.length;
  
  const proxyList = document.getElementById('proxyList');
  proxyList.innerHTML = allConfigs.map(config => `
    <div class="proxy-card bg-gray-800 p-4 rounded-lg border border-gray-700">
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-bold truncate">کانفیگ #${config.id}</h3>
        <span class="text-sm ${config.status === 'good' ? 'text-green-500' : 
          config.status === 'medium' ? 'text-yellow-500' : 
          config.status === 'bad' ? 'text-red-500' : 'text-gray-500'}">
          ${config.status === 'good' ? 'عالی' : 
           config.status === 'medium' ? 'متوسط' : 
           config.status === 'bad' ? 'ضعیف' : 'تست نشده'}
        </span>
      </div>
      <div class="mb-4">
        <div class="flex justify-between text-sm text-gray-400 mb-1">
          <span>پینگ:</span>
          <span>${config.ping ? `${config.ping} ms` : '--'}</span>
        </div>
      </div>
      <div class="flex gap-2">
        <button onclick="testPing(${config.id})" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded">
          <i class="fas fa-bolt mr-1"></i> تست
        </button>
        <button onclick="copyConfig('${config.config.replace(/'/g, "\\'")}')" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded">
          <i class="fas fa-copy mr-1"></i> کپی
        </button>
      </div>
    </div>
  `).join('');
};

// توابع کمکی
const setLoadingState = (loading) => {
  isLoading = loading;
  const icon = document.getElementById('refreshIcon');
  if (loading) {
    icon.classList.add('fa-spin');
  } else {
    icon.classList.remove('fa-spin');
  }
};

const showToast = (message, type) => {
  const toast = document.createElement('div');
  toast.className = `fixed bottom-6 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg ${
    type === 'success' ? 'bg-green-600' : 'bg-red-600'
  } text-white flex items-center`;
  toast.innerHTML = `
    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-times-circle'} mr-2"></i>
    ${message}
  `;
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.remove();
  }, 3000);
};

const copyConfig = (text) => {
  navigator.clipboard.writeText(text)
    .then(() => showToast('کانفیگ کپی شد', 'success'))
    .catch(() => showToast('خطا در کپی', 'error'));
};

// شروع برنامه
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('refreshBtn').addEventListener('click', loadConfigs);
  document.getElementById('testAllBtn').addEventListener('click', testAllConfigs);
  
  loadConfigs();
  
  // بررسی هر 30 ثانیه برای آپدیت
  setInterval(loadConfigs, 30000);
});
</script>
</body>
</html>
